<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>T.V. Vierhoeven – QR Kiosk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#F4E64C">
  <style>
    :root{
      --tvv-yellow:#F4E64C;
      --panel:#fff;
      --text:#0b0b0b;
      --shadow:0 8px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0; background:var(--tvv-yellow);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      color:var(--text);
      display:flex; flex-direction:column; gap:10px; padding:16px;
      align-items:center;
    }
    header{width:100%;max-width:960px;display:flex;align-items:center;gap:12px;}
    .logo{display:flex;align-items:center;gap:10px;}
    .logo svg{height:36px;width:auto;display:block;}
    .brand{font-weight:800;letter-spacing:.2px;}
    .frame-wrap{
      width:100%; max-width:960px; flex:1;
      display:flex; align-items:center; justify-content:center;
      min-height:60vh; border-radius:20px; overflow:hidden;
      background:var(--panel); box-shadow:var(--shadow);
      border:2px solid rgba(0,0,0,.06);
      position:relative;
    }
    iframe{width:100%; height:100%; border:0; background:#fff;}
    .controls{display:none;}
    footer{font-size:12px; color:#333; opacity:.8}
    .safe{padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}

    /* Tap overlay for fullscreen permission */
    .tap-overlay{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.5); color:#fff; z-index:5;
      font-size:clamp(16px,3vw,22px); text-align:center; padding:24px;
      backdrop-filter:saturate(1.2) blur(2px);
    }
    .tap-overlay.hidden{display:none;}
    .tap-btn{
      margin-top:14px; padding:10px 16px; background:#fff; color:#000; border-radius:12px; font-weight:800; border:0;
    }

    /* Direct link notice */
    .notice{
      width:100%;max-width:960px; text-align:center; font-size:13px; opacity:.9;
    }
    .notice a{color:#000; font-weight:700;}
  </style>
</head>
<body class="safe">

  <header>
    <div class="logo" aria-hidden="true" title="T.V. Vierhoeven">
      <!-- Simple inline SVG logo badge -->
      <svg viewBox="0 0 120 40" role="img" aria-label="TV Vierhoeven">
        <rect x="0" y="0" width="120" height="40" rx="8" fill="#F4E64C" stroke="#0b0b0b" stroke-width="2"/>
        <text x="12" y="26" font-family="Arial, Helvetica, sans-serif" font-weight="800" font-size="18" fill="#0b0b0b">TV Vierhoeven</text>
      </svg>
      <span class="brand">QR Check-in</span>
    </div>
  </header>

  <div class="frame-wrap">
    <div id="overlay" class="tap-overlay hidden">
      <div>
        <div>Tik om fullscreen te activeren</div>
        <button class="tap-btn" id="tapBtn">Open fullscreen</button>
      </div>
    </div>
    <iframe id="qrframe" title="QR Check-in"></iframe>
  </div>

  <div class="notice">
    Zie je niets? <a id="directLink" href="#" target="_blank" rel="noopener">Open de QR direct</a>
  </div>

  <footer>© T.V. Vierhoeven — Kiosk modus</footer>

<script>
  // === Config ===
  const QR_URL = "https://pr01.allunited.nl/x/location_checkin_qrcode.php?id=UUpXbytRSUN5NzBMTDZ0NUIxTWt2enZ2TUlFa0FheHh5VHRVeXgyQXdnOUMydDU0NGo5bGpwR3JESmNqTm9INTc4V21hQ2tZVUhacTNHT0hXcWMxeFdHb0F5TXBLV0NTZm9vcHlRdXJoWUJ6M0tEL1k1amhOVVhDN3BKN2l5MlVzRUI2LzVsMllLNlhHcUFJTERObCtTOVI4bDhHdEQwMHZzd3pSWkxDWlhHeFg4ZEN6ODB5SVhmSUFXWFNCVzVIYWV2YzY4c3NSZ2dyWVhhU2NUTEc3QkRXWkZQdi9uY2I1SElTQWZPMEJRQT0=";

  const frame = document.getElementById("qrframe");
  const overlay = document.getElementById("overlay");
  const directLink = document.getElementById("directLink");
  const tapBtn = document.getElementById("tapBtn");

  function cacheBusted(url){ return url + (url.includes('?') ? '&' : '?') + "t=" + Date.now(); }

  // Build iframe content with scaling that always fits
  function iframeHtml(src){
    return `<!doctype html><html lang="nl"><head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
      <style>
        html,body{height:100%;margin:0;background:#fff;}
        .wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:2vmin;}
        img{width:100%;height:100%;object-fit:contain;image-rendering:pixelated;}
        .msg{position:fixed;left:50%;top:10px;transform:translateX(-50%);font:14px/1.4 system-ui;background:#000;color:#fff;padding:6px 10px;border-radius:10px;opacity:.8}
      </style>
    </head><body>
      <div class="wrap">
        <img id="qri" alt="QR" src="${src}">
      </div>
      <div id="errmsg" class="msg" style="display:none"></div>
      <script>
        const FIVE_MIN = 5*60*1000;
        const BASE = ${JSON.stringify(QR_URL)};
        const img = document.getElementById('qri');
        const msg = document.getElementById('errmsg');
        function bust(){ img.src = BASE + (BASE.includes('?') ? '&' : '?') + 't=' + Date.now(); }
        setInterval(bust, FIVE_MIN);
        img.addEventListener('error', () => {
          msg.textContent = 'Afbeelding kon niet geladen worden.';
          msg.style.display='block';
        });
      <\/script>
    </body></html>`;
  }

  function renderSrcdoc(){
    frame.removeAttribute('src');
    frame.srcdoc = iframeHtml(cacheBusted(QR_URL));
  }

  function renderIframeDirect(){
    frame.srcdoc = "";
    frame.removeAttribute('srcdoc');
    frame.src = cacheBusted(QR_URL);
  }

  // Try srcdoc first (best scaling). If we don't see a load within timeout, fallback.
  function renderWithFallback(){
    return new Promise((resolve) => {
      let settled = false;
      renderSrcdoc();
      const onLoad = () => { if (!settled) { settled = true; cleanup(); resolve('srcdoc'); } };
      const onError = () => { /* ignore; error is in inner doc */ };
      frame.addEventListener('load', onLoad, { once:true });
      frame.addEventListener('error', onError, { once:true });
      const timer = setTimeout(() => {
        if (!settled) {
          renderIframeDirect();
          const onLoad2 = () => { if (!settled) { settled = true; cleanup(); resolve('iframe'); } };
          frame.addEventListener('load', onLoad2, { once:true });
        }
      }, 2500);
      function cleanup(){ try{ clearTimeout(timer);}catch(e){} }
    });
  }

  // Outer refresh as well, so even if inner fails it retries
  function scheduleRefresh(){
    setInterval(() => {
      renderWithFallback();
    }, 5 * 60 * 1000);
  }

  // Fullscreen helpers
  async function tryFullscreen(){
    const el = document.documentElement;
    const req = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
    if (!req) return false;
    try {
      await req.call(el);
      return true;
    } catch(e) {
      return false;
    }
  }

  async function ensureFullscreen(){
    const ok = await tryFullscreen();
    if (!ok) {
      overlay.classList.remove('hidden');
    }
  }

  async function init(){
    directLink.href = QR_URL;
    await renderWithFallback();
    scheduleRefresh();

    try {
      if ('wakeLock' in navigator) {
        let wakeLock = await navigator.wakeLock.request('screen');
        document.addEventListener('visibilitychange', async () => {
          if (document.visibilityState === 'visible') {
            try{ wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
          }
        });
      }
    } catch(e) {}

    ensureFullscreen();
  }

  tapBtn?.addEventListener('click', async () => {
    overlay.classList.add('hidden');
    await ensureFullscreen();
  });

  window.addEventListener('load', init);
</script>
</body>
</html>
